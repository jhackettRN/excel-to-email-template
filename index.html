<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Trials Email Generator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #1a365d; margin-bottom: 8px; font-size: 24px; }
        .subtitle { color: #64748b; margin-bottom: 24px; font-size: 14px; }
        .panel { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 20px; }
        .panel h2 { color: #334155; font-size: 16px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e2e8f0; }
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .upload-zone:hover, .upload-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
        .upload-zone input { display: none; }
        .upload-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-text { color: #64748b; }
        .upload-text strong { color: #3b82f6; }
        .file-info { margin-top: 16px; padding: 12px; background: #f0fdf4; border-radius: 6px; color: #166534; display: none; }
        .btn { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: #2563eb; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background: #64748b; }
        .btn-secondary:hover { background: #475569; }
        .btn-group { display: flex; gap: 12px; margin-top: 16px; }
        .output-container { display: none; }
        .email-preview { background: #fefefe; border: 1px solid #e2e8f0; border-radius: 6px; padding: 24px; font-family: Calibri, Arial, sans-serif; font-size: 11pt; line-height: 1.5; max-height: 600px; overflow-y: auto; }
        .email-preview a { color: #0563c1; }
        .copy-feedback { position: fixed; top: 20px; right: 20px; background: #22c55e; color: white; padding: 12px 20px; border-radius: 6px; display: none; animation: fadeIn 0.3s; z-index: 1000; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .stat { background: #f8fafc; padding: 12px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 600; color: #1e40af; }
        .stat-label { font-size: 12px; color: #64748b; }
        .error { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 12px; border-radius: 6px; margin-top: 16px; display: none; }
        .loading { display: none; align-items: center; gap: 8px; color: #64748b; margin-top: 16px; }
        .spinner { width: 20px; height: 20px; border: 2px solid #e2e8f0; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Clinical Trials Email Generator</h1>
        <p class="subtitle">Upload your Excel file to generate a formatted email for Outlook</p>

        <div class="panel">
            <h2>1. Upload Excel File</h2>
            <div class="upload-zone" id="uploadZone">
                <input type="file" id="fileInput" accept=".xlsx,.xls">
                <div class="upload-icon">ðŸ“Š</div>
                <p class="upload-text">Drag & drop your Excel file here or <strong>click to browse</strong></p>
            </div>
            <div class="file-info" id="fileInfo"></div>
            <div class="error" id="uploadError"></div>
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                <span>Processing file...</span>
            </div>
        </div>

        <div class="output-container" id="outputContainer">
            <div class="panel">
                <h2>2. Summary</h2>
                <div class="stats" id="stats"></div>
            </div>

            <div class="panel">
                <h2>3. Email Preview</h2>
                <div class="email-preview" id="emailPreview"></div>
                <div class="btn-group">
                    <button class="btn" id="copyBtn">Copy to Clipboard</button>
                    <button class="btn btn-secondary" id="copyHtmlBtn">Copy as HTML</button>
                </div>
            </div>
        </div>
    </div>

    <div class="copy-feedback" id="copyFeedback">Copied to clipboard!</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const uploadError = document.getElementById('uploadError');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const outputContainer = document.getElementById('outputContainer');
        const statsContainer = document.getElementById('stats');
        const emailPreview = document.getElementById('emailPreview');
        const copyBtn = document.getElementById('copyBtn');
        const copyHtmlBtn = document.getElementById('copyHtmlBtn');
        const copyFeedback = document.getElementById('copyFeedback');

        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) processFile(e.target.files[0]);
        });

        async function processFile(file) {
            if (!file.name.match(/\.xlsx?$/i)) {
                showError('Please upload an Excel file (.xlsx or .xls)');
                return;
            }

            fileInfo.textContent = `Selected: ${file.name}`;
            fileInfo.style.display = 'block';
            uploadError.style.display = 'none';
            loadingIndicator.style.display = 'flex';
            outputContainer.style.display = 'none';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/parse', {
                    method: 'POST',
                    body: formData
                });

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    throw new Error('Server returned invalid response: ' + text.substring(0, 100));
                }

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to process file');
                }

                renderOutput(data);
            } catch (err) {
                showError(err.message);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function showError(message) {
            uploadError.textContent = message;
            uploadError.style.display = 'block';
        }

        function renderOutput(data) {
            const { config, studies, stats } = data;

            statsContainer.innerHTML = `
                <div class="stat"><div class="stat-value">${stats.totalStudies}</div><div class="stat-label">Total Studies</div></div>
                <div class="stat"><div class="stat-value">${stats.newStudies}</div><div class="stat-label">New Studies</div></div>
                <div class="stat"><div class="stat-value">${stats.updatedStudies}</div><div class="stat-label">Updated Studies</div></div>
                <div class="stat"><div class="stat-value">${stats.brandCount}</div><div class="stat-label">Brands</div></div>
            `;

            const emailHtml = generateEmailHtml(config, studies);
            emailPreview.innerHTML = emailHtml;
            outputContainer.style.display = 'block';
        }

        function generateEmailHtml(config, studies) {
            const month = config.Report_Month || 'December';
            const greeting = config.Greeting || 'Good afternoon Sun Pharma team,';
            const closing = config.Closing || 'Kind regards,';
            const clientProduct = config.Client_Product || 'ILUMYAÂ®';

            const grouped = {};
            studies.forEach(s => {
                const brand = s.Brand || 'Other';
                if (!grouped[brand]) grouped[brand] = [];
                grouped[brand].push(s);
            });

            const sortedBrands = Object.keys(grouped).sort((a, b) => {
                if (a === clientProduct) return -1;
                if (b === clientProduct) return 1;
                return a.localeCompare(b);
            });

            let html = `<p>${greeting}</p>
<p>&nbsp;</p>
<p>Please see below the studies listed on ClinicalTrials.gov that were updated in ${month} with strategic implications for ${clientProduct}. If you wish to obtain full details for these studies, please click on the NCT number, which will take you to the ClinicalTrials.gov page for that trial. The full search output is also attached for your review. Because of the large number of updates, the studies are organized by agent below.</p>
<p>&nbsp;</p>
<p><strong>Updated studies:</strong></p>
<p>&nbsp;</p>`;

            sortedBrands.forEach(brand => {
                html += `<p><strong>${brand}</strong></p>\n`;

                grouped[brand].forEach(study => {
                    const newTag = study.Is_New_Study ? ' [new study]' : '';
                    html += `<p>${study.Study_Title}${newTag}<br>`;
                    html += `<a href="${study.Study_URL}">${study.NCT_Number}</a><br>`;

                    if (study.Phase) {
                        html += `Phase: ${study.Phase}<br>`;
                    }
                    html += `Study sponsor: ${study.Sponsor}<br>`;
                    html += `Study status: ${study.Status}<br>`;
                    html += `Start date: ${study.Start_Date}<br>`;

                    if (study.Primary_Completion_Date) {
                        const upd = isFieldUpdated(study, 'Primary Completion Date') ? ' [updated in ' + month + ']' : '';
                        html += `Primary completion date: ${study.Primary_Completion_Date}${upd}<br>`;
                    }

                    if (study.Completion_Date) {
                        const upd = isFieldUpdated(study, 'Completion Date') ? ' [updated in ' + month + ']' : '';
                        html += `Completion date: ${study.Completion_Date}${upd}<br>`;
                    }

                    if (study.Results_First_Posted) {
                        const upd = isFieldUpdated(study, 'Results First Posted') ? ' [updated in ' + month + ']' : '';
                        html += `Results posted: ${study.Results_First_Posted}${upd}<br>`;
                    }

                    if (study.Strategic_Implications) {
                        html += `Strategic implications: ${study.Strategic_Implications}`;
                    }

                    html += `</p>\n<p>&nbsp;</p>\n`;
                });
            });

            html += `<p>${closing}</p>`;
            return html;
        }

        function isFieldUpdated(study, fieldName) {
            if (!study.Updated_Fields) return false;
            return study.Updated_Fields.toLowerCase().includes(fieldName.toLowerCase());
        }

        copyBtn.addEventListener('click', async () => {
            try {
                const htmlContent = emailPreview.innerHTML;
                const plainText = emailPreview.innerText;

                const blob = new Blob([htmlContent], { type: 'text/html' });
                const clipboardItem = new ClipboardItem({
                    'text/html': blob,
                    'text/plain': new Blob([plainText], { type: 'text/plain' })
                });

                await navigator.clipboard.write([clipboardItem]);
                showCopyFeedback();
            } catch (err) {
                const range = document.createRange();
                range.selectNodeContents(emailPreview);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                document.execCommand('copy');
                selection.removeAllRanges();
                showCopyFeedback();
            }
        });

        copyHtmlBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(emailPreview.innerHTML);
                showCopyFeedback();
            } catch (err) {
                console.error('Copy failed:', err);
            }
        });

        function showCopyFeedback() {
            copyFeedback.style.display = 'block';
            setTimeout(() => { copyFeedback.style.display = 'none'; }, 2000);
        }
    });
    </script>
</body>
</html>
